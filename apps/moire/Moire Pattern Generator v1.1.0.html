<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <meta http-equiv="X-UA-Compatible" content="ie=edge">
    <meta name="mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <title>Moire Pattern Generator v1.1.0</title>
    <style>
        :root {
            --bg-color: #0f172a;
            --panel-bg: #1e293b;
            --text-main: #f8fafc;
            --text-muted: #94a3b8;
            --accent-color: #3b82f6;
            --accent-hover: #2563eb;
            --border-color: #334155;
            --input-track: #475569;
        }

        body { 
            margin: 0; 
            background: linear-gradient(135deg, #0f172a 0%, #1e1b4b 100%);
            color: var(--text-main); 
            font-family: 'Segoe UI', Roboto, Helvetica, Arial, sans-serif;
            display: flex;
            align-items: center;
            justify-content: center;
            min-height: 100vh;
            min-height: 100dvh; 
            overflow: hidden; 
            padding: 20px;
            box-sizing: border-box;
        }

        #rotate-warning { 
            display: none; 
        }

        /* Fullscreen button */
        #fullscreen-btn {
            position: fixed;
            top: 10px;
            right: 10px;
            background: rgba(0,0,0,0.5);
            color: white;
            border: 1px solid rgba(255,255,255,0.3);
            border-radius: 4px;
            padding: 5px 10px;
            cursor: pointer;
            z-index: 1000;
            font-size: 12px;
            text-transform: uppercase;
        }

        #fullscreen-btn:hover {
            background: var(--accent-color);
        }

        /* Force landscape on mobile */
        @media screen and (orientation: portrait) {
            #app-wrapper, #fullscreen-btn { 
                display: none !important; 
            }
            
            #rotate-warning {
                display: flex;
                flex-direction: column;
                justify-content: center;
                align-items: center;
                position: fixed;
                top: 0; 
                left: 0;
                width: 100%; 
                height: 100%;
                background: #111;
                color: #fff;
                font-family: Arial, sans-serif;
                text-align: center;
                z-index: 9999;
                padding: 20px;
                box-sizing: border-box;
            }
        }

        #app-wrapper {
            display: flex;
            background: var(--panel-bg);
            padding: 20px;
            border-radius: 16px;
            box-shadow: 0 10px 40px rgba(0,0,0,0.6);
            gap: 20px;
            width: 100%;
            max-width: 1200px;
            /* Constrain height to fit in viewport with some margin */
            max-height: 95vh;
            max-height: 95dvh;
            border: 1px solid var(--border-color);
            box-sizing: border-box;
            flex-direction: row;
            align-items: stretch;
        }

        /* --- LEFT PANEL --- */
        #controls {
            width: 320px;
            min-width: 300px;
            display: flex;
            flex-direction: column;
            gap: 15px;
            padding-right: 10px;
            border-right: 1px solid var(--border-color);
            overflow-y: auto;
            box-sizing: border-box;
            padding-left: 0;
        }

        /* --- CANVAS CONTAINER --- */
        #canvas-container {
            flex-grow: 1;
            display: flex;
            justify-content: center;
            align-items: center;
            overflow: hidden;
            position: relative; 
            min-width: 0; 
            min-height: 0;
        }

        canvas { 
            width: 100%;
            height: 100%;
            object-fit: contain;
            max-width: 100%;
            max-height: 100%;
            background: #000; 
            border-radius: 8px;
            box-shadow: inset 0 0 20px rgba(0,0,0,0.8);
            border: 1px solid #000;
            display: block;
        }

        #watermark {
            position: absolute;
            bottom: 15px;
            right: 20px;
            font-family: monospace;
            font-weight: bold;
            font-size: 14px;
            color: rgba(255, 255, 255, 0.5);
            pointer-events: none; 
            user-select: none;
            background: rgba(0,0,0,0.3);
            padding: 4px 8px;
            border-radius: 4px;
        }

        h1 {
            margin: 0 0 15px 0;
            font-size: 20px;
            font-weight: 600;
            color: var(--accent-color);
            text-transform: uppercase;
            letter-spacing: 1px;
            border-bottom: 2px solid var(--border-color);
            padding-bottom: 10px;
        }

        .control-group {
            background: rgba(15, 23, 42, 0.5);
            padding: 12px;
            border-radius: 8px;
            border: 1px solid var(--border-color);
        }

        .label-row {
            display: flex;
            justify-content: space-between;
            font-size: 13px;
            margin-bottom: 8px;
            color: var(--text-muted);
            font-weight: 500;
        }

        .value-display {
            color: var(--accent-color);
            font-family: monospace;
            font-weight: bold;
        }

        .input-row {
            display: flex;
            align-items: center;
            gap: 8px;
        }

        button.step-btn {
            background: var(--border-color);
            color: var(--text-main);
            border: none;
            width: 24px;
            height: 24px;
            border-radius: 4px;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 16px;
            line-height: 1;
            transition: background 0.2s;
        }

        button.step-btn:hover {
            background: var(--accent-color);
        }

        button.step-btn:active {
            transform: scale(0.95);
        }
        
        /* Export Buttons */
        .export-row {
            display: flex;
            gap: 10px;
            margin-top: 5px;
        }
        
        button.export-btn {
            flex: 1;
            background: var(--panel-bg);
            color: var(--accent-color);
            border: 1px solid var(--accent-color);
            border-radius: 6px;
            padding: 8px;
            cursor: pointer;
            font-weight: 600;
            font-size: 13px;
            transition: all 0.2s;
        }
        
        button.export-btn:hover {
            background: var(--accent-color);
            color: white;
        }

        /* Custom Range Slider */
        input[type="range"] {
            -webkit-appearance: none; 
            appearance: none;
            width: 100%; 
            background: transparent; 
            height: 20px; 
            margin: 0;
        }

        input[type="range"]::-webkit-slider-thumb {
            -webkit-appearance: none;
            appearance: none;
            height: 16px;
            width: 16px;
            border-radius: 50%;
            background: var(--accent-color);
            cursor: pointer;
            margin-top: -6px; 
            box-shadow: 0 0 5px rgba(59, 130, 246, 0.5);
        }

        input[type="range"]::-webkit-slider-runnable-track {
            width: 100%;
            height: 4px;
            cursor: pointer;
            background: var(--border-color);
            border-radius: 2px;
            transform: translateY(8px); 
        }

         /* --- INFO BOX --- */
        .info-box {
            font-size: 12px;
            color: var(--text-muted);
            background: rgba(0,0,0,0.2);
            padding: 10px;
            border-radius: 6px;
            margin-top: auto;
            border: 1px solid var(--border-color);
            line-height: 1.4;
        }

        /* --- RESPONSIVE TWEAKS FOR MOBILE LANDSCAPE --- */
        @media screen and (max-width: 900px) and (orientation: landscape) {
            body { 
                padding: 5px; 
            }
            #app-wrapper {
                padding: 10px;
                gap: 10px;
                max-height: 98dvh;
            }
             #controls { 
                width: 260px; 
                min-width: 260px;
                gap: 10px;
                padding-left: 30px; 
                border-left: 1px solid rgba(255,255,255,0.05);
            }
            h1 {
                font-size: 16px;
                margin-bottom: 10px;
            }
            .control-group { 
                padding: 8px; 
            }
        }
    </style>
</head>
<body>

<div id="rotate-warning">
    <div style="font-size: 50px; margin-bottom: 20px;">ðŸ”„</div>
    <h2>Please Rotate Your Device</h2>
    <p>This experiment requires landscape mode.</p>
</div>

<button id="fullscreen-btn" onclick="toggleFullScreen()">â›¶ Fullscreen</button>

<div id="app-wrapper">
    <!-- LEFT SIDE: CONTROLS -->
    <div id="controls">
        <h1>Moire Pattern Generator <span style="font-size:0.6em; color: var(--text-muted)">v1.1.0</span></h1>
        
        <div class="control-group">
            <div class="label-row">
                <span>Wave Density</span>
                <span id="val_waves" class="value-display">42</span>
            </div>
            <div class="input-row">
                <button class="step-btn" onclick="adjustValue('waves', -1)">-</button>
                <input type="range" id="waves" min="20" max="100" step="0.1" value="42">
                <button class="step-btn" onclick="adjustValue('waves', 1)">+</button>
            </div>
        </div>

        <div class="control-group">
            <div class="label-row">
                <span>Rotation (deg)</span>
                <span id="val_rot" class="value-display">0</span>
            </div>
            <div class="input-row">
                <button class="step-btn" onclick="adjustValue('rot', -1)">-</button>
                <input type="range" id="rot" min="-180" max="180" step="0.1" value="0">
                <button class="step-btn" onclick="adjustValue('rot', 1)">+</button>
            </div>
        </div>

        <div class="control-group">
            <div class="label-row">
                <span>Point Radius</span>
                <span id="val_rad" class="value-display">40</span>
            </div>
            <div class="input-row">
                <button class="step-btn" onclick="adjustValue('rad', -1)">-</button>
                <input type="range" id="rad" min="10" max="60" step="1" value="40">
                <button class="step-btn" onclick="adjustValue('rad', 1)">+</button>
            </div>
        </div>

        <div class="control-group">
            <div class="label-row">
                <span>Precision / Threshold</span>
                <span id="val_prec" class="value-display">0.95</span>
            </div>
            <div class="input-row">
                <button class="step-btn" onclick="adjustValue('prec', -1)">-</button>
                <input type="range" id="prec" min="0.9" max="0.999" step="0.001" value="0.95">
                <button class="step-btn" onclick="adjustValue('prec', 1)">+</button>
            </div>
        </div>

        <div class="control-group">
            <div class="label-row">
                <span>Brightness / Alpha</span>
                <span id="val_alpha" class="value-display">0.5</span>
            </div>
            <div class="input-row">
                <button class="step-btn" onclick="adjustValue('alpha', -1)">-</button>
                <input type="range" id="alpha" min="0.01" max="1.0" step="0.01" value="0.5">
                <button class="step-btn" onclick="adjustValue('alpha', 1)">+</button>
            </div>
        </div>
        
        <!-- EXPORT SECTION -->
        <div class="control-group">
            <div class="label-row">
                <span>Save Image</span>
            </div>
            <div class="export-row">
                <button class="export-btn" onclick="downloadImage('png')">PNG</button>
                <button class="export-btn" onclick="downloadImage('jpg')">JPG</button>
            </div>
        </div>

        <div class="info-box">
            Real-time GLSL calculation based on wave height (Z).<br><br>
            <span style="color: #60a5fa">Blue</span> = Low Intensity<br>
            <span style="color: #4ade80">Green</span> = Medium<br>
            <span style="color: #f87171">Red</span> = High (Peaks)
        </div>
    </div>

    <!-- RIGHT SIDE: CANVAS -->
    <div id="canvas-container">
        <canvas id="glcanvas"></canvas>
        <div id="watermark">neondreamslab.com</div>
    </div>
</div>

<!-- ========================= SHADERS ========================= -->

<script id="vertex-shader" type="x-shader/x-vertex">
    attribute vec2 a_position;
    
    uniform float u_waves;
    uniform float u_rot;
    uniform float u_prec;
    uniform float u_pointSize;
    uniform vec2 u_resolution;

    varying vec3 v_color; 
    varying float v_discard;

    // Optional palette function if needed for future extensions
    vec3 palette(float t) {
        float r = smoothstep(0.5, 0.8, t);
        float g = smoothstep(0.2, 0.7, t) - smoothstep(0.8, 1.0, t); 
        float b = smoothstep(0.0, 0.4, t) - smoothstep(0.6, 1.0, t);
        return vec3(r, g, b);
    }

    void main() {
        float xres = u_resolution.x;
        vec2 pos = a_position * (xres / 2.0); 

        float PI = 3.14159265359;
        float fact1 = (xres / u_waves) / (2.0 * PI);

        float s = pos.x * cos(u_rot) + pos.y * sin(u_rot);
        float t = pos.y * cos(u_rot) - pos.x * sin(u_rot);

        float z = (sin(s / fact1 + PI / 2.0) + sin(t / fact1 + PI / 2.0)) / 2.0;

        if (z >= u_prec) {
            float z_norm = (z - u_prec) / (1.0 - u_prec);
            
            vec3 baseColor = vec3(0.0);
            baseColor.b = smoothstep(0.0, 0.4, z_norm); 
            baseColor.g = smoothstep(0.3, 0.7, z_norm);
            baseColor.r = smoothstep(0.6, 1.0, z_norm);

            v_color = baseColor;
            
            gl_Position = vec4(a_position, 0.0, 1.0);
            gl_PointSize = u_pointSize;
            v_discard = 0.0;
        } else {
            gl_Position = vec4(0.0, 0.0, 0.0, 1.0);
            gl_PointSize = 0.0;
            v_discard = 1.0;
        }
    }
</script>

<script id="fragment-shader" type="x-shader/x-fragment">
    precision mediump float;
    
    uniform float u_alpha;
    varying vec3 v_color;
    varying float v_discard;

    void main() {
        if (v_discard > 0.5) discard;

        vec2 coord = 2.0 * gl_PointCoord - 1.0;
        float dist = length(coord);
        if (dist > 1.0) discard;

        float glow = pow(1.0 - dist, 2.0);

        gl_FragColor = vec4(v_color * glow, u_alpha);
    }
</script>

<!-- ========================= APP LOGIC ========================= -->

<script>
    // 1. CONFIG & SETUP
    const CONFIG = {
        gridSteps: 500,
        watermarkText: "neondreamslab.com"
    };

    const canvas = document.getElementById('glcanvas');
    const container = document.getElementById("canvas-container");
    
    // We need preserveDrawingBuffer to save images
    const gl = canvas.getContext('webgl', { 
        alpha: false, 
        depth: false, 
        antialias: false, 
        preserveDrawingBuffer: true 
    });

    if (!gl) { 
        alert("Your browser does not support WebGL."); 
    }

    // 2. HELPER FUNCTIONS
    function createShader(gl, type, sourceId) {
        const source = document.getElementById(sourceId).text;
        const shader = gl.createShader(type);
        gl.shaderSource(shader, source);
        gl.compileShader(shader);
        
        if (!gl.getShaderParameter(shader, gl.COMPILE_STATUS)) {
            console.error(gl.getShaderInfoLog(shader));
            return null;
        }
        return shader;
    }

    // Helper for stepping buttons and sliders
    window.adjustValue = function(id, direction) {
        const input = document.getElementById(id);
        const step = parseFloat(input.step) || 1;
        let newVal = parseFloat(input.value) + (step * direction);
        
        const min = parseFloat(input.min);
        const max = parseFloat(input.max);

        if (newVal < min) newVal = min;
        if (newVal > max) newVal = max;
        
        // Float precision fix for smaller steps
        if (step < 1) {
            newVal = parseFloat(newVal.toFixed(3));
        }
        
        input.value = newVal;
        // The value change will be picked up in the render loop
    };

    window.toggleFullScreen = function() {
        if (!document.fullscreenElement) {
            document.documentElement.requestFullscreen().catch(err => {
                console.log(`Error attempting to enable fullscreen: ${err.message}`);
            });
        } else {
            if (document.exitFullscreen) {
                document.exitFullscreen();
            }
        }
    };

    window.downloadImage = function(format) {
        const tempCanvas = document.createElement('canvas');
        tempCanvas.width = canvas.width;
        tempCanvas.height = canvas.height;
        const ctx = tempCanvas.getContext('2d');
        
        // Draw WebGL canvas to temp canvas
        ctx.drawImage(canvas, 0, 0);
        
        // Draw Watermark
        ctx.save();
        ctx.font = "bold 20px monospace";
        ctx.fillStyle = "rgba(255, 255, 255, 0.5)";
        ctx.textAlign = "right";
        ctx.textBaseline = "bottom";
        
        ctx.shadowColor = "rgba(0,0,0,0.5)";
        ctx.shadowBlur = 4;
        ctx.shadowOffsetX = 1;
        ctx.shadowOffsetY = 1;

        ctx.fillText(CONFIG.watermarkText, tempCanvas.width - 20, tempCanvas.height - 15);
        ctx.restore();
        
        // Export
        const mimeType = format === 'jpg' ? 'image/jpeg' : 'image/png';
        const link = document.createElement('a');
        link.download = `moire_pattern_${Date.now()}.${format}`;
        link.href = tempCanvas.toDataURL(mimeType, 0.9);
        link.click();
    };

    // 3. WEBGL INITIALIZATION
    const program = gl.createProgram();
    gl.attachShader(program, createShader(gl, gl.VERTEX_SHADER, "vertex-shader"));
    gl.attachShader(program, createShader(gl, gl.FRAGMENT_SHADER, "fragment-shader"));
    gl.linkProgram(program);
    gl.useProgram(program);

    // --- Generate Grid Points ---
    const pointData = [];
    for (let y = 0; y < CONFIG.gridSteps; y++) {
        for (let x = 0; x < CONFIG.gridSteps; x++) {
            // Normalized coordinates -1 to 1
            pointData.push(
                (x / CONFIG.gridSteps) * 2 - 1, 
                (y / CONFIG.gridSteps) * 2 - 1
            );
        }
    }
    
    const buffer = gl.createBuffer();
    gl.bindBuffer(gl.ARRAY_BUFFER, buffer);
    gl.bufferData(gl.ARRAY_BUFFER, new Float32Array(pointData), gl.STATIC_DRAW);

    const posLoc = gl.getAttribLocation(program, 'a_position');
    gl.enableVertexAttribArray(posLoc);
    gl.vertexAttribPointer(posLoc, 2, gl.FLOAT, false, 0, 0);

    const locs = {
        waves: gl.getUniformLocation(program, 'u_waves'),
        rot: gl.getUniformLocation(program, 'u_rot'),
        prec: gl.getUniformLocation(program, 'u_prec'),
        size: gl.getUniformLocation(program, 'u_pointSize'),
        res: gl.getUniformLocation(program, 'u_resolution'),
        alpha: gl.getUniformLocation(program, 'u_alpha')
    };

    // Blend settings for glowing effect
    gl.enable(gl.BLEND);
    gl.blendFunc(gl.SRC_ALPHA, gl.ONE);

    // 4. UI REFERENCES
    const ui = {
        waves: document.getElementById('waves'),
        rot: document.getElementById('rot'),
        rad: document.getElementById('rad'),
        prec: document.getElementById('prec'),
        alpha: document.getElementById('alpha')
    };
    
    const valDisp = {
        waves: document.getElementById('val_waves'),
        rot: document.getElementById('val_rot'),
        rad: document.getElementById('val_rad'),
        prec: document.getElementById('val_prec'),
        alpha: document.getElementById('val_alpha')
    };

    // 5. RENDER LOOP
    function render() {
        // Update UI Text Displays
        valDisp.waves.innerText = ui.waves.value;
        valDisp.rot.innerText   = parseFloat(ui.rot.value).toFixed(1);
        valDisp.rad.innerText   = ui.rad.value;
        valDisp.prec.innerText  = parseFloat(ui.prec.value).toFixed(3);
        valDisp.alpha.innerText = parseFloat(ui.alpha.value).toFixed(2);

        // Clear & Draw
        gl.clearColor(0, 0, 0, 1);
        gl.clear(gl.COLOR_BUFFER_BIT);

        // Pass Uniforms
        gl.uniform1f(locs.waves, parseFloat(ui.waves.value));
        gl.uniform1f(locs.rot, parseFloat(ui.rot.value) * (Math.PI / 180.0));
        gl.uniform1f(locs.prec, parseFloat(ui.prec.value));
        gl.uniform1f(locs.size, parseFloat(ui.rad.value));
        gl.uniform1f(locs.alpha, parseFloat(ui.alpha.value));
        gl.uniform2f(locs.res, canvas.width, canvas.height);

        // Draw points
        gl.drawArrays(gl.POINTS, 0, pointData.length / 2);

        requestAnimationFrame(render);
    }
    
    // 6. RESIZE HANDLING
    function resize() {
        // Reset CSS size to container
        canvas.style.width = '100%';
        canvas.style.height = '100%';

        const w = container.clientWidth;
        const h = container.clientHeight;
        const size = Math.min(w, h);

        const newWidth = Math.floor(size);
        const newHeight = Math.floor(size);

        // Only update if size changed
        if (canvas.width !== newWidth || canvas.height !== newHeight) {
            canvas.width = newWidth;
            canvas.height = newHeight;
            canvas.style.width = newWidth + 'px';
            canvas.style.height = newHeight + 'px';
            gl.viewport(0, 0, canvas.width, canvas.height);
        }
    }

    // Event Listeners
    window.addEventListener('resize', resize);
    window.addEventListener('orientationchange', function() {
        // Delay resize to allow layout to settle
        setTimeout(resize, 200);
        setTimeout(resize, 500);
    });

    // Start
    setTimeout(resize, 100);
    resize();
    render();

</script>
</body>
</html>